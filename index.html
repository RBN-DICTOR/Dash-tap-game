<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dash Tap — Neon</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{--bg:#060717;--card:#0d1620;--accent:#00ffe1;--muted:#9aa4b2;--hot:#ff6b6b}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#020316,#081428);color:#eaf6f1}
    .container{width:360px;max-width:96vw;margin:14px auto;padding:14px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:18px}
    .small{font-size:12px;color:var(--muted)}
    #gameWrap{margin-top:12px;display:flex;flex-direction:column;align-items:center}
    canvas{width:320px;height:480px;border-radius:12px;background:linear-gradient(180deg,#041022,#081827);touch-action:none}
    .hud{width:320px;display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .scoreBox{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:10px;font-weight:700}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .btn{background:linear-gradient(180deg,#12202a,#0a1418);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-size:13px;color:#eaf6f1;cursor:pointer;transition:all 0.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,255,225,0.1)}
    .btn-primary{background:linear-gradient(180deg,#00ffe1,#008c7a);color:#000;font-weight:bold}
    .btn-secondary{background:linear-gradient(180deg,#ff6b6b,#cc0000);color:white}
    .panel{background:linear-gradient(180deg,#071226,#0c1720);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:300px;text-align:center}
    .big{font-size:22px;font-weight:800;margin:6px 0}
    .muted{color:var(--muted);font-size:13px}
    .shop{display:flex;gap:8px;margin-top:8px;overflow:auto;padding-bottom:8px}
    .skin{min-width:64px;height:64px;border-radius:10px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform 0.2s}
    .skin:hover{transform:scale(1.05)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:50}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0d1720;color:#eaf6f1;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    .continue-options{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap;justify-content:center}
    .combo-display{font-size:14px;background:rgba(255,215,102,0.1);padding:4px 8px;border-radius:6px;margin-top:5px}
    .shake{animation:shake 0.5s}
    @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-2px)}20%,40%,60%,80%{transform:translateX(2px)}}
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,255,225,0.4)}70%{box-shadow:0 0 0 10px rgba(0,255,225,0)}100%{box-shadow:0 0 0 0 rgba(0,255,225,0)}}
    .floating{animation:floating 3s ease-in-out infinite}
    @keyframes floating{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
  </style>
  
  <script src="https://telegram.org/js/games.js"></script>
  
  <script src="https://sdk.monetag.com/script/loader/BD0tKFtA7e" async></script>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div>
        <h1>Dash Tap</h1>
        <div class="small" id="userName">Guest</div>
      </div>
      <div style="text-align:right">
        <div class="small">Coins <span id="coinCount">0</span></div>
        <div class="small">Streak <span id="streak">0</span></div>
      </div>
    </header>
    <div id="gameWrap">
      <div style="position:relative">
        <canvas id="gameCanvas" width="320" height="480"></canvas>
        <div id="startScreen" style="display:flex;position:absolute;inset:0;align-items:center;justify-content:center;z-index:20">
          <div class="panel">
            <div class="big">Dash Tap — Neon</div>
            <div class="muted">Tap the glowing target before the timer runs out. Each hit speeds up the game.</div>
            <div style="height:12px"></div>
            <button class="btn btn-primary" id="startBtn">Start Game</button>
            <div style="height:8px"></div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <div class="muted">Best <strong id="bestLocal">0</strong></div>
              <div class="muted">Combo <strong id="bestCombo">0</strong></div>
            </div>
          </div>
        </div>
        <div id="gameOverScreen" style="display:none;position:absolute;inset:0;align-items:center;justify-content:center;z-index:20">
          <div class="panel">
            <div class="big">Game Over!</div>
            <div class="muted">Score: <strong id="finalScore">0</strong></div>
            <div class="muted">Best: <strong id="finalBest">0</strong></div>
            <div class="muted">Combo: <strong id="finalCombo">0</strong></div>
            <div class="continue-options">
              <button class="btn btn-primary" id="continueBtn">Watch Ad to Continue</button>
              <button class="btn" id="restartBtn">Start Again</button>
            </div>
          </div>
        </div>
      </div>
      <div class="hud">
        <div class="scoreBox">Score: <span id="score">0</span></div>
        <div class="scoreBox">Combo: <span id="combo">0</span></div>
      </div>
      <div class="controls">
        <button class="btn" id="adBtn">Watch Ad +100 Coins</button>
        <button class="btn" id="shopBtn">Shop</button>
        <button class="btn" id="leaderBtn">Leaderboard</button>
      </div>
      <div id="shopModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center">
        <div class="modal-backdrop"></div>
        <div class="panel modal" style="width:320px;max-width:94vw">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="big">Shop</div><button class="btn" id="closeShop">Close</button>
          </div>
          <div class="muted" style="margin-top:6px">Buy skins using coins</div>
          <div class="shop" id="shopList"></div>
        </div>
      </div>
      <div id="leaderModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center">
        <div class="modal-backdrop"></div>
        <div class="panel modal" style="width:320px;max-width:94vw">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="big">Leaderboard</div><button class="btn" id="closeLeader">Close</button>
          </div>
          <div id="leaderList" style="margin-top:8px;max-height:260px;overflow:auto"><div class="muted">Loading…</div></div>
        </div>
      </div>
      <footer style="text-align:center;margin-top:8px"><div class="muted">Built for Telegram Mini Apps — Works in browser too</div></footer>
    </div>
  </div>
  <div id="toastHolder" style="pointer-events:none"></div>
  <audio id="tapSound" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3"></audio>
  <audio id="comboSound" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
  <audio id="gameOverSound" preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-losing-bleep-2029.mp3"></audio>

  <script>
    const SHEETDB_URL = "https://sheetdb.io/api/v1/1ir7bgefz4eyr";

    // Game state
    let score = 0, best = Number(localStorage.getItem('best') || 0), timeLimit = 1200, running = false;
    let target = { x: 160, y: 240, r: 36 }, timerRef = null, particles = [];
    let coins = Number(localStorage.getItem('coins') || 0);
    let streak = Number(localStorage.getItem('streak') || 0);
    let lastPlay = Number(localStorage.getItem('lastPlay') || 0);
    let skin = localStorage.getItem('skin') || 'neon';
    let combo = 0;
    let bestCombo = Number(localStorage.getItem('bestCombo') || 0);
    let isGameOver = false;

    const skins = [
      { id: 'neon', cost: 0, label: 'Neon', draw: (x, y, r) => { let g = ctx.createRadialGradient(x, y, 2, x, y, r); g.addColorStop(0, '#00ffe1'); g.addColorStop(1, '#00383a'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill(); } },
      { id: 'gold', cost: 150, label: 'Gold', draw: (x, y, r) => { let g = ctx.createLinearGradient(x - r, y - r, x + r, y + r); g.addColorStop(0, '#ffdc7b'); g.addColorStop(1, '#d88b00'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill(); } },
      { id: 'galaxy', cost: 250, label: 'Galaxy', draw: (x, y, r) => { let g = ctx.createRadialGradient(x, y, 2, x, y, r); g.addColorStop(0, '#b28cff'); g.addColorStop(1, '#140026'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill(); } },
      { id: 'block', cost: 80, label: 'Block', draw: (x, y, r) => { ctx.fillStyle = '#ff7b7b'; ctx.fillRect(x - r, y - r, r * 2, r * 2); } }
    ];

    let timeSlow = false;
    let timeSlowEnd = 0;

    // --- MONETAG ADS INTEGRATION (UPDATED) ---

    // Wrapper function to handle the specific Monetag snippet
    function triggerMonetagAd() {
      return new Promise((resolve, reject) => {
        // Check if the specific function you provided exists in the window
        if (typeof window.show_10336096 === 'function') {
            console.log("Calling Monetag show_10336096...");
            
            // Call the function exactly as requested
            window.show_10336096().then(() => {
                console.log("Ad watched successfully.");
                resolve(true);
            }).catch((err) => {
                console.error("Ad closed or failed:", err);
                reject("Ad failed");
            });
        } else {
            console.error("Monetag function show_10336096 not found. Script likely not loaded.");
            reject("Ad SDK not ready");
        }
      });
    }

    // Logic for "Watch Ad to Continue"
    function showContinueAd() {
      // If user bought "No Ads", skip ad entirely
      if (localStorage.getItem('noads') === 'true') {
        continueGame();
        return;
      }

      toast('Loading Ad...');
      
      triggerMonetagAd().then(() => {
        // success - user watched the ad
        toast('Ad watched!');
        
        // Give small coin reward
        const rewardAmount = 25;
        coins += rewardAmount;
        localStorage.setItem('coins', coins);
        document.getElementById('coinCount').textContent = coins;
        
        // Actually continue the game
        continueGame();
        
      }).catch((err) => {
        // If ad fails (e.g. adblocker or no internet), warn user
        toast('Ad unavailable. Please check internet.');
      });
    }

    // Logic for "Free Coins" Button
    function showCoinAd() {
      if (localStorage.getItem('noads') === 'true') {
        toast('Ads disabled. Enjoy!');
        return;
      }

      toast('Loading Ad...');

      triggerMonetagAd().then(() => {
        const rewardAmount = 100;
        coins += rewardAmount;
        localStorage.setItem('coins', coins);
        document.getElementById('coinCount').textContent = coins;
        toast(`+${rewardAmount} coins added!`);
        spawnParticles(160, 240, '#ffd700', 50);
      }).catch((err) => {
        toast('Ad unavailable. Please check internet.');
      });
    }

    // ------------------------------------------

    function continueGame() {
      isGameOver = false;
      document.getElementById('gameOverScreen').style.display = 'none';
      
      // Reset timer but keep current score
      timeLimit = Math.max(800, 1200 - (score * 8));
      running = true;
      
      timeSlow = true;
      timeSlowEnd = Date.now() + 3000;
      
      spawnParticles(target.x, target.y, '#00ff00', 40);
      canvas.classList.add('pulse');
      setTimeout(() => canvas.classList.remove('pulse'), 1000);
      
      randomizeTarget();
      startTimer();
      requestAnimationFrame(loop);
    }

    // Telegram WebApp & Stars
    const tg = window.Telegram?.WebApp || null;
    if (tg) {
      tg.ready();
      tg.expand();
      if (tg.initDataUnsafe?.user) {
        document.getElementById('userName').textContent = tg.initDataUnsafe.user.first_name || tg.initDataUnsafe.user.username || 'Player';
      }

      const items = [
        { id: "noads", title: "Remove Ads Forever", price: 19 },
        { id: "doublecoins", title: "2x Coins Forever", price: 49 },
        { id: "vip", title: "VIP Skin + 500 Coins", price: 99 }
      ];

      tg.MainButton.text = "Shop (⭐)";
      tg.MainButton.color = "#00ffe1";
      tg.MainButton.textColor = "#000";
      tg.MainButton.show();

      tg.MainButton.onClick(() => {
        tg.showPopup({
          title: "Buy with Stars",
          message: "Choose a boost",
          buttons: items.map(item => ({ type: "default", text: `${item.title} — ${item.price} ⭐`, id: item.id }))
        }, (buttonId) => {
          if (buttonId) {
            const item = items.find(i => i.id === buttonId);
            tg.openInvoice({
              title: item.title,
              description: "Thank you for supporting Dash Tap!",
              payload: "dash-tap-" + buttonId,
              currency: "XTR",
              prices: [{ label: item.title, amount: item.price * 100 }]
            });
          }
        });
      });

      tg.onEvent('invoiceClosed', (event) => {
        if (event.status === 'paid') {
          const id = event.payload.split('-')[1];
          if (id === "noads") {
            localStorage.setItem('noads', 'true');
            toast('Ads removed! Thank you!');
          }
          if (id === "doublecoins") {
            localStorage.setItem('doublecoins', 'true');
            toast('2x Coins activated!');
          }
          if (id === "vip") {
            coins += 500;
            localStorage.setItem('coins', coins);
            document.getElementById('coinCount').textContent = coins;
            skin = 'galaxy';
            localStorage.setItem('skin', skin);
            toast('VIP Package activated!');
          }
        }
      });
    }

    // Canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let DPR = Math.min(2, window.devicePixelRatio || 1);
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width * DPR);
      canvas.height = Math.round(rect.height * DPR);
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Initial UI update
    document.getElementById('bestLocal').textContent = best;
    document.getElementById('bestCombo').textContent = bestCombo;
    document.getElementById('coinCount').textContent = coins;
    document.getElementById('streak').textContent = streak;

    // Sounds
    const tapSound = document.getElementById('tapSound');
    const comboSound = document.getElementById('comboSound');
    const gameOverSound = document.getElementById('gameOverSound');
    function playTap() { tapSound.currentTime = 0; tapSound.play().catch(() => {}); }
    function playCombo() { comboSound.currentTime = 0; comboSound.play().catch(() => {}); }
    function playGameOver() { gameOverSound.currentTime = 0; gameOverSound.play().catch(() => {}); }

    function rand(min, max) { return Math.random() * (max - min) + min; }
    function toast(msg, t = 1800) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      document.getElementById('toastHolder').appendChild(el);
      setTimeout(() => el.remove(), t);
    }

    function spawnParticles(x, y, color, count = 14) {
      for (let i = 0; i < count; i++) {
        particles.push({ 
          x, y, 
          vx: rand(-3, 3), 
          vy: rand(-5, -0.5), 
          life: rand(30, 60), 
          age: 0, 
          color,
          size: rand(2, 4)
        });
      }
    }

    function drawBackground() {
      ctx.save();
      const w = canvas.width / DPR, h = canvas.height / DPR;
      const g = ctx.createLinearGradient(0, 0, w, h);
      g.addColorStop(0, 'rgba(0,20,30,0.25)');
      g.addColorStop(1, 'rgba(0,6,12,0.55)');
      ctx.fillStyle = g; 
      ctx.fillRect(0, 0, w, h);
      
      // Animated stars
      ctx.globalAlpha = 0.15; 
      ctx.fillStyle = '#fff';
      for (let i = 0; i < 12; i++) {
        const x = (i * 30 + (Date.now() / 200 % 30)) % w;
        const y = (Math.sin(i * 0.5 + Date.now() / 1000) * 20 + h/2);
        const size = Math.sin(Date.now() / 1000 + i) * 2 + 2;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.globalAlpha = 1; 
      ctx.restore();
    }

    function drawTarget() {
      const s = skins.find(x => x.id === skin) || skins[0];
      const pulse = 0.12 + 0.08 * Math.sin(Date.now() / 180);
      
      const g = ctx.createRadialGradient(target.x, target.y, target.r * 0.2, target.x, target.y, target.r * 2);
      g.addColorStop(0, `rgba(0,255,225,${pulse})`);
      g.addColorStop(1, 'rgba(0,16,20,0)');
      ctx.fillStyle = g; 
      ctx.beginPath(); 
      ctx.arc(target.x, target.y, target.r * 2, 0, Math.PI * 2); 
      ctx.fill();
      
      s.draw(target.x, target.y, target.r);
      
      ctx.beginPath(); 
      ctx.lineWidth = combo > 5 ? 5 : 3;
      ctx.strokeStyle = combo > 10 ? '#ffd700' : combo > 5 ? '#ff6b6b' : `rgba(0,255,225,${pulse})`;
      ctx.arc(target.x, target.y, target.r + 6, 0, Math.PI * 2); 
      ctx.stroke();
      
      if (combo > 3) {
        ctx.fillStyle = combo > 10 ? '#ffd700' : '#ff6b6b';
        ctx.font = 'bold 14px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(`${combo}x`, target.x, target.y + 4);
      }
    }

    function drawParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx; 
        p.y += p.vy; 
        p.vy += 0.12; 
        p.age++;
        ctx.globalAlpha = Math.max(0, 1 - p.age / p.life);
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        if (p.age > p.life) particles.splice(i, 1);
      }
    }

    let startTime = 0;
    function startTimer() {
      startTime = Date.now();
      if (timerRef) clearTimeout(timerRef);
      const adjustedTime = timeSlow ? timeLimit * 1.5 : timeLimit;
      timerRef = setTimeout(endGame, adjustedTime);
    }
    function timeLeft() {
      const elapsed = Date.now() - startTime;
      const adjustedTime = timeSlow ? timeLimit * 1.5 : timeLimit;
      return Math.max(0, adjustedTime - elapsed);
    }

    let lastFrame = Date.now();
    function loop() {
      if (!running) return;
      const now = Date.now();
      
      if (timeSlow && now > timeSlowEnd) {
        timeSlow = false;
      }
      
      lastFrame = now;
      ctx.clearRect(0, 0, canvas.width / DPR, canvas.height / DPR);
      drawBackground();
      drawTarget();
      
      const rem = timeLeft() / (timeSlow ? timeLimit * 1.5 : timeLimit);
      ctx.beginPath(); 
      ctx.lineWidth = 4; 
      ctx.strokeStyle = timeSlow ? '#00ff00' : 'rgba(0,255,225,0.6)';
      ctx.arc(canvas.width / DPR / 2, 18, 10, -Math.PI / 2, -Math.PI / 2 + rem * Math.PI * 2); 
      ctx.stroke();
      
      if (timeSlow) {
        ctx.fillStyle = 'rgba(0,255,0,0.2)';
        ctx.fillRect(0, 0, canvas.width / DPR, canvas.height / DPR);
      }
      
      drawParticles();
      requestAnimationFrame(loop);
    }

    function endGame() {
        if (!running) return;
        gameOver();
    }

    function randomizeTarget() {
      target.x = rand(50, canvas.width / DPR - 50);
      target.y = rand(80, canvas.height / DPR - 80);
      target.r = Math.max(24, rand(30, 48 - Math.min(20, score / 5)));
    }

    function startGame() {
      score = 0; 
      combo = 0;
      timeLimit = 1200; 
      running = true;
      isGameOver = false;
      
      document.getElementById('score').textContent = 0;
      document.getElementById('combo').textContent = 0;
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('gameOverScreen').style.display = 'none';
      
      randomizeTarget(); 
      startTimer(); 
      lastFrame = Date.now(); 
      requestAnimationFrame(loop);
    }

    function gameOver() {
      running = false; 
      isGameOver = true;
      clearTimeout(timerRef);
      playGameOver();
      
      const coinMultiplier = localStorage.getItem('doublecoins') === 'true' ? 2 : 1;
      const reward = Math.floor(score / 2) * coinMultiplier + combo * 2;
      
      coins += reward;
      localStorage.setItem('coins', coins); 
      document.getElementById('coinCount').textContent = coins;
      
      const now = Date.now(), oneDay = 24 * 60 * 60 * 1000;
      if (now - lastPlay < oneDay * 1.5) { 
        streak = Math.min(999, streak + 1); 
      } else { 
        streak = 1; 
      }
      lastPlay = now; 
      localStorage.setItem('lastPlay', lastPlay); 
      localStorage.setItem('streak', streak);
      document.getElementById('streak').textContent = streak;
      
      if (score > best) { 
        best = score; 
        localStorage.setItem('best', best); 
        document.getElementById('bestLocal').textContent = best; 
      }
      
      if (combo > bestCombo) {
        bestCombo = combo;
        localStorage.setItem('bestCombo', bestCombo);
        document.getElementById('bestCombo').textContent = bestCombo;
      }
      
      document.getElementById('finalScore').textContent = score;
      document.getElementById('finalBest').textContent = best;
      document.getElementById('finalCombo').textContent = combo;
      
      spawnParticles(target.x, target.y, '#ff0000', 40);
      submitScore(score);
      
      setTimeout(() => {
        document.getElementById('gameOverScreen').style.display = 'flex';
        canvas.classList.add('shake');
        setTimeout(() => canvas.classList.remove('shake'), 500);
      }, 300);
    }

    function onTap(e) {
      e.preventDefault(); 
      e.stopPropagation(); 

      if (!running || isGameOver) return;
      
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      
      const x = (clientX - rect.left) * (320 / rect.width);
      const y = (clientY - rect.top) * (480 / rect.height);
      
      const dx = x - target.x, dy = y - target.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist < target.r + 6) { 
        playTap();
        score++; 
        combo++;
        document.getElementById('score').textContent = score;
        document.getElementById('combo').textContent = combo;
        
        if (combo % 5 === 0) {
          playCombo();
          const comboBonus = combo * 2;
          coins += comboBonus;
          localStorage.setItem('coins', coins);
          document.getElementById('coinCount').textContent = coins;
          spawnParticles(x, y, '#ffd700', 25);
          toast(`Combo ${combo}! +${comboBonus} coins`);
        }
        
        const coinMultiplier = localStorage.getItem('doublecoins') === 'true' ? 2 : 1;
        if (Math.random() < 0.35) {
          coins += 1 * coinMultiplier; 
          localStorage.setItem('coins', coins); 
          document.getElementById('coinCount').textContent = coins;
          spawnParticles(x, y, '#ffd166', 12);
        }
        
        spawnParticles(x, y, '#00ffe1', 18);
        timeLimit = Math.max(400, timeLimit - Math.max(14, Math.floor(score * 0.5)));
        randomizeTarget(); 
        startTimer();
      } else {
        gameOver();
      }
    }
    
    canvas.addEventListener('mousedown', onTap);
    canvas.addEventListener('touchstart', onTap);

    async function submitScore(scoreVal) {
      const name = document.getElementById('userName').textContent || 'Player';
      const payload = { name, score: Number(scoreVal), date: new Date().toISOString().slice(0, 10) };
      try {
        await fetch(SHEETDB_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (e) { }
    }

    async function loadLeaderboard() {
      const div = document.getElementById('leaderList');
      div.innerHTML = '<div class="muted">Loading…</div>';
      try {
        const res = await fetch(SHEETDB_URL + '?sort_by=score&sort_order=desc');
        const data = await res.json();
        div.innerHTML = data.slice(0, 20).map((r, i) => `
          <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02)">
            <div><strong>${i + 1}. ${r.name || 'Player'}</strong></div>
            <div>${r.score}</div>
          </div>`).join('');
      } catch (e) {
        div.innerHTML = '<div class="muted">No connection</div>';
      }
    }

    function showShop() {
      const list = document.getElementById('shopList'); 
      list.innerHTML = '';
      skins.forEach(s => {
        const el = document.createElement('div'); 
        el.className = 'skin';
        el.style.borderColor = s.id === skin ? 'var(--accent)' : '';
        el.innerHTML = `
          <div style="text-align:center">
            ${s.label}
            <div style="font-size:12px;color:${s.id === skin ? 'var(--accent)' : 'var(--muted)'}">
              ${s.cost}¢
            </div>
          </div>`;
        el.onclick = () => {
          if (s.id === skin) { 
            toast('Already equipped'); 
            return; 
          }
          if (coins >= s.cost) {
            coins -= s.cost; 
            localStorage.setItem('coins', coins); 
            document.getElementById('coinCount').textContent = coins;
            skin = s.id; 
            localStorage.setItem('skin', skin); 
            toast('Bought: ' + s.label);
            showShop(); // Refresh shop
          } else {
            toast('Not enough coins');
            canvas.classList.add('shake');
            setTimeout(() => canvas.classList.remove('shake'), 500);
          }
        };
        list.appendChild(el);
      });
      document.getElementById('shopModal').style.display = 'flex';
    }

    // Event Listeners
    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('continueBtn').onclick = showContinueAd;
    document.getElementById('restartBtn').onclick = startGame;
    document.getElementById('shopBtn').onclick = showShop;
    document.getElementById('closeShop').onclick = () => document.getElementById('shopModal').style.display = 'none';
    document.getElementById('leaderBtn').onclick = () => { document.getElementById('leaderModal').style.display = 'flex'; loadLeaderboard(); };
    document.getElementById('closeLeader').onclick = () => document.getElementById('leaderModal').style.display = 'none';
    document.getElementById('adBtn').onclick = showCoinAd;

    // Daily bonus
    (function () {
      const today = new Date().toDateString();
      if (localStorage.getItem('dailyGrant') !== today) {
        coins += 15;
        localStorage.setItem('coins', coins); 
        document.getElementById('coinCount').textContent = coins;
        localStorage.setItem('dailyGrant', today);
        toast('Daily bonus: +15 coins!');
      }
    })();

    // Initialize
    window.onload = () => {
      canvas.classList.add('floating');
      setTimeout(() => {
        toast('Welcome to Dash Tap! Tap fast, earn coins!');
      }, 1000);
    };
  </script>
</body>
</html>
